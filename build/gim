#!/bin/sh

#-------------------------------------------------------------------------------
# Copyright 2018 Dominik Salvet
# SPDX-License-Identifier: MIT
# https://gitlab.com/dominiksalvet/gim
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# SOFTWARE DEPENDENCIES
#-------------------------------------------------------------------------------

# list of required software
SW_REQUIRED='command echo [ git make cd mkdir sed grep rm ls umask logname sudo printenv id'

# check if some software is missing
for i in $SW_REQUIRED; do
    # software is missing if at least one piece of software is missing
    if ! command -v "$i" > /dev/null; then
        echo "$0: Required software '$i' is missing." >&2
        # the program dependencies may be missing
        if [ "$i" = hda-verb ]; then
            echo 'POSSIBLE SOLUTIONS:
  * install program dependencies' >&2
        fi
        exit 1
    fi
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# the current version of the program
VERSION=1.1.0

GIT_URL_FORMAT='https://<provider>.<domain>/<author>/<project>.git'

HELP_MESSAGE="USAGE: $0 [OPTION]... ACTION GIT_URL [MAKE_ARG]...

ACTION:
  install    install a program originating from the given Git URL
  uninstall  uninstall a program originating from the given Git URL
  update     update a program originating from the given Git URL

GIT_URL:
  $GIT_URL_FORMAT

OPTION:
  -clear-cache  clear cache of downloaded Git project repositories and exit
  -help         show this help and exit
  -about        show information and exit
  -version      show version and exit

MAKE_ARG:
  arguments for make commands in format <VAR>=<value>, do not use only <value>"

ABOUT_MESSAGE="gim $VERSION
Install, uninstall or update Git projects in an easy way with a single command.

Copy"'right 2018 Dominik Salvet
SPDX License Identifier: MIT
https://gitlab.com/dominiksalvet/gim'

HINT_MESSAGE="POSSIBLE SOLUTIONS:
  * use the '$0 -help' command for more information"

# cache directory to store downloaded Git repositories
CACHE_DIR=~/.cache/gim

# DESCRIPTION:
#   Add a given make argument to the '$make_args' variable.
# PARAMETERS:
#   $1 - make argument to be added
add_make_arg() {
    if [ -z "$make_args" ]; then
        make_args="$1"
    else
        make_args="$make_args $1"
    fi
}

# DESCRIPTION:
#   Fill the '$project_current_version' variable with the current version of a given project.
# PARAMETERS:
#   $1 - project name
fill_project_current_version() {
    # get the current version of the program
    if ! project_current_version="$("$1" --version)" 2>/dev/null; then
        project_current_version="$("$1" -version)" 2>/dev/null
    fi || project_current_version=

    # check if non-empty version was returned
    if [ -z "$project_current_version" ]; then
        echo "$0: Neither the '--version' flag nor the '-version' flag has been recognized.
POSSIBLE SOLUTIONS:
  * refer to a developer of the given Git URL's project about gim compliance"
        return 1
    fi
}

# DESCRIPTION:
#   Perform a make target call with given arguments.
# PARAMETERS:
#   $1 - make target
#   $2 - make arguments
make_call() {
    if [ -z "$2" ]; then
        make "$1"
    else
        make "$1" "$2"
    fi
}

#-------------------------------------------------------------------------------
# PROCESSING PARAMETERS
#-------------------------------------------------------------------------------

# processing each parameter separately
for i in "$@"; do
    if [ ! -z "$action" ]; then # if the action has been selected
        if [ -z "$project_url" ]; then # if the project Git URL is not set
            project_url="$i" # next up are only make arguments
        else # accept only make arguments
            add_make_arg "$i"
        fi
    else
        case "$i" in
            install)
                action=install
                ;;
            uninstall)
                action=uninstall
                ;;
            update)
                action=update
                ;;
            -clear-cache)
                rm -rf "${CACHE_DIR:?}/"
                exit 0
                ;;
            -help)
                echo "$HELP_MESSAGE"
                exit 0
                ;;
            -about)
                echo "$ABOUT_MESSAGE"
                exit 0
                ;;
            -version)
                echo "$VERSION"
                exit 0
                ;;
            *)
                echo "$0: The option '$i' was not recognized.
$HINT_MESSAGE" >&2
                exit 1
                ;;
        esac
    fi
done

# check arguments if valid and parse required information
if [ -z "$action" ]; then # check if argument with an action provided
    echo "$0: No argument with action provided.
$HINT_MESSAGE" >&2
    exit 1
elif [ -z "$project_url" ]; then # check if argument with Git URL provided
    echo "$0: No argument with Git URL provided.
$HINT_MESSAGE" >&2
    exit 1
else # both arguments provided
    # check the format of given Git URL
    if ! echo "$project_url" | grep -q -E -e 'https://[^\.]+\.[^/]+/[^/]+/[^\.]+\.git'; then
        echo "$0: Supplied Git URL is invalid.
POSSIBLE SOLUTIONS:
  * use the '$GIT_URL_FORMAT' format" >&2
        exit 1
    fi

    # get project name and author name from the given Git URL
    project_name="$(echo "$project_url" | sed -E -e 's/.git$//; s|.*/||')"
    project_author="$(echo "$project_url" | sed -E -e 's|/[^/]*$||; s|.*/||')"
fi

#-------------------------------------------------------------------------------
# OBTAINING THE REPOSITORY
#-------------------------------------------------------------------------------

# set up the mask for permissions of manipulated files
umask 000

# create a cache directory for the program
mkdir -p "$CACHE_DIR/$project_author/$project_name/" &&
cd "$CACHE_DIR/$project_author/$project_name/" || {
    echo "$0: It wasn't possible to access the gim's cache directory.
POSSIBLE SOLUTIONS:
  * free up some storage space
  * contact a gim developer" >&2
    exit 1
}

if [ -z "$(ls -A)" ]; then # if the cache directory for the target project is empty
    git clone "$project_url" . # clone the Git repository to the this directory
else # if not empty
    # check if the directory is a valid Git repository
    if [ -d '.git' ] && git diff --quiet; then # expecting that the '.git' contents is not corrupted
        git checkout master && # checkout the master branch for the pull command
        git pull && # get the most recent state of the repository
        git fetch --tags # get the most recent state of the repository tags
    else
        echo "$0: The Git repository in cache is corrupted.
POSSIBLE SOLUTIONS:
  * clear the program's cache using the '$0 -clear-cache' command" >&2
        exit 1
    fi
fi || {
    echo "$0: The Git repository can't be obtained in the most recent state.
POSSIBLE CAUSES:
  * your device is not connected to the Internet
  * your device is low on storage" >&2
    exit 1
}

# get the latest stable release of the obtained Git project
project_last_version="$(git describe --abbrev=0)"

# verify that the repository has at least one tag
if [ -z "$project_last_version" ]; then
    echo "$0: The given Git repository has no commit tagged.
POSSIBLE SOLUTIONS:
  * refer to a developer of the given Git URL's project about gim compliance" >&2
    exit 1
fi

#-------------------------------------------------------------------------------
# EXECUTE SELECTED ACTION
#-------------------------------------------------------------------------------

if [ "$(id -u)" -eq 0 ]; then # if running as root
    # use user's '$PATH' variable instead of the root's one to detect installations in user's '$PATH' when running as root
    PATH="$(sudo -iu "$(logname)" printenv PATH)" || {
        echo "$0: It wasn't possible to obtain user's '$PATH' variable to detect all gim installations.
POSSIBLE SOLUTIONS:
  * contact a gim developer" >&2
        exit 1
    }
fi

case "$action" in
    install)
        if [ -f "$(command -v "$project_name")" ]; then # check if the project already installed
            fill_project_current_version "$project_name" || exit
            if [ "$project_current_version" = "$project_last_version" ]; then # if the versions are the same
                echo 'The latest stable release of this Git project is already installed.
SUCCESS'
                exit 0
            else
                echo "$0: This Git project is already install, but it is not updated.
POSSIBLE SOLUTIONS:
  * use the 'update' action instead of the used 'install' action" >&2
                exit 1
            fi
        fi

        git checkout "$project_last_version" && # use the latest repository tag
        make_call install "$make_args" # install the program
        ;;
    uninstall)
        if [ ! -f "$(command -v "$project_name")" ]; then # if the project is not installed
            echo 'This Git project is not installed.
SUCCESS'
            exit 0 # uninstallation exits with a success eventually
        fi

        fill_project_current_version "$project_name" || exit
        git checkout "$project_current_version" && # use the program version as a tag
        make_call uninstall "$make_args" # uninstall the program
        ;;
    update)
        if [ -f "$(command -v "$project_name")" ]; then # check if the project installed
            fill_project_current_version "$project_name" || exit
            if [ "$project_current_version" = "$project_last_version" ]; then # if the versions are the same
                echo 'The latest stable release of this Git project is already installed.
SUCCESS'
                exit 0
            fi
        else # the project is not installed
            echo "$0: The project originating from given Git URL is not installed.
POSSIBLE SOLUTIONS:
  * use the 'install' action instead of the used 'update' action" >&2
            exit 1
        fi

        fill_project_current_version "$project_name" || exit
        git checkout "$project_current_version" && # use the program version as a tag
        make_call uninstall "$make_args" && # uninstall the program

        git checkout "$project_last_version" && # use the latest repository tag
        make_call install "$make_args" # install the program again
        ;;
esac || {
    echo "$0: An error has occurred during the '$action' process.
POSSIBLE SOLUTIONS:
  * read the report above as it can provide required information
  * refer to a developer of the given Git URL's project" >&2
    exit 1
}

#-------------------------------------------------------------------------------
# VERIFY THE PROJECT'S STATUS
#-------------------------------------------------------------------------------

case "$action" in
    install | update)
        if [ ! -f "$(command -v "$project_name")" ]; then # if the project is not installed (as it should be now)
            echo "$0: The '$project_name' should have been installed, but it is not.
POSSIBLE SOLUTIONS:
  * refer to a developer of the given Git URL's project" >&2
            exit 1
        fi
        ;;
    uninstall)
        if [ -f "$(command -v "$project_name")" ]; then # if the project is installed (as it shouldn't be now)
            echo "$0: The '$project_name' should have been uninstalled, but it is not.
POSSIBLE SOLUTIONS:
  * refer to a developer of the given Git URL's project" >&2
            exit 1
        fi
        ;;
esac

echo 'SUCCESS'
