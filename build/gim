#!/bin/sh

#-------------------------------------------------------------------------------
# Copyright 2018 Dominik Salvet
# SPDX-License-Identifier: MIT
# https://gitlab.com/dominiksalvet/gim
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# SOFTWARE DEPENDENCIES
#-------------------------------------------------------------------------------

# list of required software
SW_REQUIRED='command echo [ git make cd mkdir sed grep'

# check if some software is missing
for i in $SW_REQUIRED; do
    # software is missing if at least one piece of software is missing
    if ! command -v "$i" > /dev/null; then
        echo "$0: Required software '$i' is missing, action canceled." >&2
        # the program dependencies may be missing
        if [ "$i" = hda-verb ]; then
            echo 'POSSIBLE SOLUTIONS:
  * install program dependencies' >&2
        fi
        exit 1
    fi
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# the current version of the program
VERSION=1.0.0

HELP_MESSAGE="Usage: $0 [OPTION]... ACTION GIT_URL

ACTION:
  install    install a program originating from the given Git URL
  uninstall  uninstall a program originating from the given Git URL
  update     update a program originating from the given Git URL

OPTION:
  -help     show this help and exit
  -about    show information and exit
  -version  show version and exit"

ABOUT_MESSAGE="gim $VERSION
Install, uninstall or update Git projects in an easy and unified way with a single command.

Copy"'right 2018 Dominik Salvet
SPDX License Identifier: MIT
https://gitlab.com/dominiksalvet/gim'

# cache directory to store downloaded Git repositories
CACHE_DIR=~/.cache/gim

#-------------------------------------------------------------------------------
# PROCESSING PARAMETERS
#-------------------------------------------------------------------------------

# processing each parameter separately
for i in "$@"; do
    if [ ! -z "$action" ]; then # if the action has been selected in the previous variable
        # get Git URL and discard all following parameters
        git_url="$i"
        break
    else
        case "$i" in
            install)
                action=install
                ;;
            uninstall)
                action=uninstall
                ;;
            update)
                action=update
                ;;
            -help)
                echo "$HELP_MESSAGE"
                exit 0
                ;;
            -about)
                echo "$ABOUT_MESSAGE"
                exit 0
                ;;
            -version)
                echo "$VERSION"
                exit 0
                ;;
            *)
                echo "$0: The option '$i' was not recognized.
Try '$0 -help' for more information." >&2
                exit 1
                ;;
        esac
    fi
done

# check arguments if valid
if [ -z "$action" ]; then # check if ACTION argument provided
    echo "$0: No argument with action provided.
Try '$0 -help' for more information." >&2
    exit 1
elif [ -z "$git_url" ]; then # check if GIT_URL argument provided
    echo "$0: No argument with Git URL provided.
Try '$0 -help' for more information." >&2
    exit 1
else # both arguments provided
    # check the format of given Git URL
    if ! echo "$git_url" | grep -q -E -e 'https://[^\.]+\.[^/]+/[^/]+/[^\.]+\.git'; then
        echo "$0: Supplied Git URL is invalid.
POSSIBLE SOLUTIONS:
  * use the 'https://<provider>.<domain>/<author>/<project>.git' template" >&2
        exit 1
    fi

    # get project name and author name from the given Git URL
    git_url_project="$(echo "$git_url" | sed -E -e 's/.git$//; s|.*/||')"
    git_url_author="$(echo "$git_url" | sed -E -e 's|/[^/]*$||; s|.*/||')"
fi

#-------------------------------------------------------------------------------
# EXECUTE SELECTED ACTION
#-------------------------------------------------------------------------------

# create a cache directory for the program
mkdir -p "$CACHE_DIR/$git_url_author/$git_url_project/"
cd "$CACHE_DIR/$git_url_author/$git_url_project/" || exit 1

# check if already existing a downloaded repository
if [ -d ".git" ]; then
    git checkout master
    git pull
    git getch --tags
else
    git clone "$git_url" .
fi

case "$action" in
    install)
        # use the latest repository tag
        git checkout "$(git describe --abbrev=0)"
        # install the program
        make install
        ;;
    uninstall)
        # use the program version as a tag
        git checkout "$("$git_url_project" -version)"
        # uninstall the program
        make uninstall
        ;;
    update)
        # use the program version as a tag
        git checkout "$("$git_url_project" -version)"
        # uninstall the program
        make uninstall
        # use the latest repository tag
        git checkout "$(git describe --abbrev=0)"
        # install the program again
        make install
        ;;
esac
